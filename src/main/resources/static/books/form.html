<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formulaire Livre</title>
    <link rel="stylesheet" href="/css/app.css" />
    <script src="/js/app.js" defer></script>
</head>
<body>
<div class="container">
    <h1 id="titlePage">Ajouter un livre</h1>
    <div id="message"></div>

    <div class="card" style="margin-top:12px">
        <form id="bookForm">
            <input type="hidden" id="bookId" />
            <div class="form-row">
                <div class="col">
                    <label>Titre</label>
                    <input id="inputTitle" class="input" type="text" required />
                </div>
                <div class="col">
                    <label>Auteur</label>
                    <input id="inputAuthor" class="input" type="text" required />
                </div>
            </div>

            <div style="margin-top:10px" class="form-row">
                <div class="col">
                    <label>ISBN</label>
                    <input id="inputIsbn" class="input" type="text" />
                </div>
            </div>

            <div style="margin-top:10px">
                <label>Description</label>
                <textarea id="inputDesc" rows="6" class="input"></textarea>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                <a class="btn btn-secondary" href="/books/list.html">Annuler</a>
                <button class="btn btn-primary" type="submit">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<script>
    (function(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      const form = document.getElementById('bookForm');
      const titlePage = document.getElementById('titlePage');

      async function loadBook() {
        if (!id) return;
        titlePage.textContent = 'Éditer le livre';
        try {
          const b = await apiHelpers.getBook(id);
          document.getElementById('bookId').value = b.id || '';
          document.getElementById('inputTitle').value = b.title || '';
          document.getElementById('inputAuthor').value = b.author || '';
          document.getElementById('inputIsbn').value = b.isbn || '';
          document.getElementById('inputDesc').value = b.description || '';
        } catch(err) { apiHelpers.showMessage('message','Erreur chargement : '+err.message,'danger'); }
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const payload = {
          title: document.getElementById('inputTitle').value.trim(),
          author: document.getElementById('inputAuthor').value.trim(),
          isbn: document.getElementById('inputIsbn').value.trim(),
          description: document.getElementById('inputDesc').value.trim()
        };
        try {
          if (id) {
            await apiHelpers.updateBook(id, payload);
            apiHelpers.showMessage('message','Livre mis à jour','success');
            setTimeout(()=> location.href='/books/list.html', 900);
          } else {
            await apiHelpers.createBook(payload);
            apiHelpers.showMessage('message','Livre créé','success');
            setTimeout(()=> location.href='/books/list.html', 900);
          }
        } catch(err) { apiHelpers.showMessage('message','Erreur : '+err.message,'danger'); }
      });

      document.addEventListener('DOMContentLoaded', loadBook);
    })();
</script>
</body>
</html>